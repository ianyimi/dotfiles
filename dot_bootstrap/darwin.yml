---
- name: Machine setup (Darwin OS)
  hosts: localhost
  become: true
  connection: local
  gather_facts: true
  vars:
    flyctl_version: "0.1.130"
    pulumi_version: "v3.94.2"

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

    - name: Determine the path to zsh
      ansible.builtin.shell: "command -v zsh"
      register: zsh_path
      changed_when: false

    - name: Ensure zsh is installed
      become: false
      ansible.builtin.package:
        name: zsh
        state: present

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: "{{ zsh_path.stdout }}"
      when: zsh_path.stdout != ""

- name: Brew Install
  hosts: localhost
  become: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  tasks:
    - name: Check Install - Git
      community.general.homebrew:
        name: git
        state: present

    - name: Check Install - GitHub CLI
      community.general.homebrew:
        name: gh
        state: present

    - name: Check Install - Neovim
      community.general.homebrew:
        name: neovim
        state: present

    - name: Check Install - Spotify
      community.general.homebrew:
        name: spotify
        state: present

    - name: Check Install - Tmux
      community.general.homebrew:
        name: tmux
        state: present

    - name: Check Install - WezTerm
      community.general.homebrew:
        name: wezterm
        state: present

    - name: Check Install - Arc Browser
      community.general.homebrew:
        name: arc
        state: present

    - name: Check Install - Keymapp
      community.general.homebrew:
        name: keymapp
        state: present

    - name: Check Install - Node.js
      community.general.homebrew:
        name: node
        state: present

    - name: Check Install - npm
      community.general.homebrew:
        name: npm
        state: present

    - name: Check Install - Obsidian
      community.general.homebrew:
        name: obsidian
        state: present

    - name: Check Install - Cascadia Code
      become: false
      environment:
        HOMEBREW_NO_ANALYTICS: "1"
      community.general.homebrew_cask:
        name: 
          - font-cascadia-code
        state: present

    - name: Check Install - Aerospace
      become: false
      environment:
        HOMEBREW_NO_ANALYTICS: "1"
      community.general.homebrew_cask:
        name: 
          - nikitabobko/tap/aerospace
        state: present

    - name: Check if Aerospace is running
      become: false
      shell: "pgrep -f 'Aerospace'"
      register: aerospace_status
      failed_when: false
      changed_when: false

    - name: Start Aerospace if not running
      become: false
      shell: "open -a Aerospace"
      when: aerospace_status.rc != 0

    - name: Tap FelixKratz formulae
      become: false
      community.general.homebrew_tap:
        name: FelixKratz/formulae
        state: present

    - name: Check Install - SketchyBar
      become: false
      community.general.homebrew:
        name: sketchybar
        state: present

