---
- name: Prerequisites (Git, Brew, GitHub Auth)
  hosts: localhost
  become: false
  connection: local
  tasks:
    - name: Check if Homebrew is installed
      ansible.builtin.stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check

    - name: Install Homebrew if not present
      ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: not homebrew_check.stat.exists

    - name: Ensure git is installed
      community.general.homebrew:
        name: git
        state: present

    - name: Configure git with GitHub token from Bitwarden
      block:
        - name: Check if gh CLI is installed
          ansible.builtin.command: which gh
          register: gh_check
          failed_when: false
          changed_when: false

        - name: Install gh CLI if not present
          community.general.homebrew:
            name: gh
            state: present
          when: gh_check.rc != 0

        - name: Check if gh is authenticated
          ansible.builtin.command: gh auth status
          register: gh_auth_status
          failed_when: false
          changed_when: false

        - name: Authenticate gh with Bitwarden token
          ansible.builtin.shell: |
            bw get password "GitHub Personal Access Token" | gh auth login --with-token
          environment:
            BW_SESSION: "{{ lookup('env', 'BW_SESSION') }}"
            NODE_OPTIONS: "--no-deprecation"
          when:
            - gh_auth_status.rc != 0
            - lookup('env', 'BW_SESSION') | length > 0
          timeout: 30
          no_log: true

        - name: Warn if gh not authenticated and no BW_SESSION
          ansible.builtin.debug:
            msg: "Skipping gh auth - BW_SESSION not set. Run 'bw-session-check && source ~/.bw-session' then re-run."
          when:
            - gh_auth_status.rc != 0
            - lookup('env', 'BW_SESSION') | length == 0

- name: Machine setup (MacOS)
  hosts: localhost
  become: true
  connection: local
  vars:
    flyctl_version: "0.1.130"
    pulumi_version: "v3.94.2"
  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

    - name: Determine the path to zsh
      ansible.builtin.shell: "command -v zsh"
      register: zsh_path
      changed_when: false

    - name: Ensure zsh is installed
      become: false
      ansible.builtin.package:
        name: zsh
        state: present

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: "{{ zsh_path.stdout }}"
      when: zsh_path.stdout != ""

- name: Brew Install (Apps)
  hosts: localhost
  become: false
  gather_facts: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  tasks:
    - name: Check Install - Spotify
      community.general.homebrew_cask:
        name: spotify
        state: present
      ignore_errors: true

    - name: Check Install - Arc Browser
      community.general.homebrew_cask:
        name: arc
        state: present
      ignore_errors: true

    - name: Check Install - Handbrake
      community.general.homebrew_cask:
        name: handbrake
        state: present
      ignore_errors: true

    - name: Check Install - Keymapp
      community.general.homebrew_cask:
        name: keymapp
        state: present
      ignore_errors: true

    - name: Check Install - Obsidian
      community.general.homebrew_cask:
        name: obsidian
        state: present
      ignore_errors: true

    - name: Check Install - Ghostty
      community.general.homebrew_cask:
        name: ghostty
        state: present
      ignore_errors: true

    - name: Check Install - Plex
      community.general.homebrew_cask:
        name: plex
        state: present
      ignore_errors: true

    - name: Check Install - Mouseless
      community.general.homebrew_cask:
        name: mouseless
        state: present
      ignore_errors: true

    - name: Check Install - Responsively
      community.general.homebrew_cask:
        name: responsively
        state: present
      ignore_errors: true

    - name: Check Install - Syncthing
      community.general.homebrew_cask:
        name: syncthing
        state: present
      ignore_errors: true

    - name: Check Install - Discord
      community.general.homebrew_cask:
        name: discord
        state: present
      ignore_errors: true

    - name: Check Install - LMStudio
      community.general.homebrew_cask:
        name: lm-studio
        state: present
      ignore_errors: true

- name: Brew Install (CLI)
  hosts: localhost
  become: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  vars:
    brew_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
  tasks:
    - name: Tap sst/tap (required for opencode)
      become: true
      become_user: "{{ brew_user }}"
      community.general.homebrew_tap:
        name: sst/tap
        state: present

    - name: Install opencode (from sst/tap)
      become: true
      become_user: "{{ brew_user }}"
      community.general.homebrew:
        name: sst/tap/opencode
        state: present
        update_homebrew: true

    - name: Check Install - Git
      community.general.homebrew:
        name: git
        state: present

    - name: Check Install - k6
      community.general.homebrew:
        name: k6
        state: present

    - name: Check Install - Bat
      community.general.homebrew:
        name: bat
        state: present

    - name: Check Install - Zsh AutoSuggestions
      community.general.homebrew:
        name: zsh-autosuggestions
        state: present

    - name: Check Install - Zsh Syntax Highlighting
      community.general.homebrew:
        name: zsh-syntax-highlighting
        state: present

    - name: Check Install - fzf
      community.general.homebrew:
        name: fzf
        state: present

    # - name: Check Install - Corepack
    #   community.general.homebrew:
    #     name: corepack
    #     state: present

    - name: Check Install - Starship
      community.general.homebrew:
        name: starship
        state: present

    - name: Check Install - Luarocks
      community.general.homebrew:
        name: luarocks
        state: present

    - name: Check Install - Lunajson
      ansible.builtin.command: luarocks install lunajson

    - name: Check Install - pnpm
      block:
        - name: Check if pnpm is already installed
          ansible.builtin.command: pnpm --version
          register: pnpm_check
          failed_when: false
          changed_when: false

        - name: Debug pnpm installation status
          ansible.builtin.debug:
            msg: "pnpm is already installed, version: {{ pnpm_check.stdout }}"
          when: pnpm_check.rc == 0

        - name: Install pnpm if not installed
          ansible.builtin.shell: "curl -fsSL https://get.pnpm.io/install.sh | sh -"
          args:
            creates: "{{ ansible_facts['env']['HOME'] }}/.local/share/pnpm"
          environment:
            PNPM_HOME: "{{ ansible_facts['env']['HOME'] }}/.local/share/pnpm"
          when: pnpm_check.rc != 0

        - name: Ensure pnpm is in the PATH
          ansible.builtin.lineinfile:
            path: ~/.zshrc
            line: 'export PATH="$HOME/.local/share/pnpm:$PATH"'
            insertafter: EOF
            state: present
          when: pnpm_check.rc != 0

        - name: Reload shell configuration
          ansible.builtin.shell: source ~/.zshrc
          args:
            executable: /bin/zsh
          when: pnpm_check.rc != 0

    - name: Check Install - Neovim
      community.general.homebrew:
        name: neovim
        state: latest

    - name: Check Install - node.js
      community.general.homebrew:
        name: node
        state: present

    - name: Check Install - GitHub CLI
      community.general.homebrew:
        name: gh
        state: present

    - name: Ensure GitHub Dash extension is installed
      block:
        - name: Check if GitHub Dash extension is installed
          command: gh extension list --version
          register: gh_dash_version
          changed_when: false
          ignore_errors: true

        - name: Install GitHub Dash extension if not present
          command: gh extension install dlvhdr/gh-dash
          when: gh_dash_version.rc != 0

    - name: Check Install - Tmux
      community.general.homebrew:
        name: tmux
        state: present

    - name: Check Install - Tmuxinator
      community.general.homebrew:
        name: tmuxinator
        state: present

    - name: Check Install - Neofetch
      community.general.homebrew:
        name: neofetch
        state: present

    - name: Check Install - curl
      community.general.homebrew:
        name: npm
        state: present

    - name: Check Install - HandBrakeCLI
      community.general.homebrew:
        name: handbrake
        state: present

    - name: Check Install - lazydocker
      community.general.homebrew:
        name: lazydocker
        state: present

    - name: Check Install - lazygit
      community.general.homebrew:
        name: lazygit
        state: present

    - name: Check Install - kubectl
      community.general.homebrew:
        name: kubectl
        state: present

    - name: Check Install - Mongosh
      community.general.homebrew:
        name: mongosh
        state: present

    - name: Check Install - Argon2
      community.general.homebrew:
        name: argon2
        state: present

    - name: Check Install - Azure CLI
      community.general.homebrew:
        name: azure-cli
        state: present

    - name: Check Install - k9s
      community.general.homebrew:
        name: k9s
        state: present

    - name: Check Install - npm
      community.general.homebrew:
        name: npm
        state: present

    - name: Check Install - fnm
      community.general.homebrew:
        name: fnm
        state: present

    - name: Check Install - RipGrep
      community.general.homebrew:
        name: ripgrep
        state: present

    - name: Set Dock to auto-hide
      become: false
      shell: "defaults write com.apple.dock autohide -bool true && killall Dock"
      changed_when: false

    - name: Tap FelixKratz formulae
      become: false
      community.general.homebrew_tap:
        name: FelixKratz/formulae
        state: present

    - name: JankyBorders
      become: false
      community.general.homebrew:
        name: borders
        state: present

    - name: Check Install - Hack Nerd Font
      become: false
      community.general.homebrew_cask:
        name: font-hack-nerd-font
        state: present

    - name: Check Install - JetBrains Mono Nerd Font
      become: false
      community.general.homebrew_cask:
        name: font-jetbrains-mono-nerd-font
        state: present

    - name: Check Install - SketchyBar
      become: false
      ignore_errors: true
      community.general.homebrew:
        name: sketchybar
        state: present

    - name: Check if SbarLua is installed
      ansible.builtin.stat:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/share/sketchybar_lua/sketchybar.so"
      register: sbarlua_stat

    - name: Clone SbarLua repository
      when: not sbarlua_stat.stat.exists
      ansible.builtin.git:
        repo: "https://github.com/FelixKratz/SbarLua.git"
        dest: "/tmp/SbarLua"
        version: "HEAD"
        force: yes

    - name: Build and install SbarLua
      when: not sbarlua_stat.stat.exists
      ansible.builtin.shell: "make install"
      args:
        chdir: "/tmp/SbarLua"

    - name: Start SketchyBar service
      become: false
      shell: "brew services start sketchybar"
      register: sketchybar_service
      changed_when: "'Successfully started' in sketchybar_service.stdout"
      failed_when: false

    - name: Set menu bar to auto-hide
      become: false
      shell: "osascript -e 'tell application \"System Events\" to tell dock preferences to set autohide menu bar to true'"
      changed_when: false

- name: Clone SketchyBar App Font Repository
  hosts: localhost
  become: false
  tasks:
    - name: Ensure packages directory exists
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/packages"
        state: directory
        mode: "0755"

    - name: Check if sketchybar-app-font repository exists
      ansible.builtin.stat:
        path: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font"
      register: sketchybar_app_font_stat

    - name: Clone sketchybar-app-font repository
      ignore_errors: true
      ansible.builtin.git:
        repo: "https://github.com/kvndrsslr/sketchybar-app-font.git"
        dest: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font"
        version: "HEAD"
        force: no
      when: not sketchybar_app_font_stat.stat.exists

- name: Update SketchyBar App Font
  hosts: localhost
  become: false
  tasks:
    - name: Check if sketchybar-app-font dist exists
      ansible.builtin.stat:
        path: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font/dist/icon_map.lua"
      register: sketchybar_dist_stat

    - name: Update sketchybar-app-font dependencies
      when: not sketchybar_dist_stat.stat.exists
      ansible.builtin.command: pnpm install
      args:
        chdir: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font"
      environment:
        PATH: "{{ ansible_facts['env']['HOME'] }}/.local/share/pnpm:{{ ansible_facts['env']['PATH'] }}"

    - name: Ensure sketchybar scripts directory exists
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.config/sketchybar/scripts"
        state: directory
        mode: "0755"

    - name: Ensure my-script.sh exists with icon map markers
      ansible.builtin.copy:
        dest: "{{ ansible_facts['env']['HOME'] }}/.config/sketchybar/scripts/my-script.sh"
        content: |
          ### START-OF-ICON-MAP
          # Here be the function
          ### END-OF-ICON-MAP
        mode: "0755"
        force: no

    - name: Build and install latest sketchybar-app-font and update icon map script
      when: not sketchybar_dist_stat.stat.exists
      ansible.builtin.command: pnpm run build:install "{{ ansible_facts['env']['HOME'] }}/.config/sketchybar/scripts/my-script.sh"
      args:
        chdir: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font"
      environment:
        PATH: "{{ ansible_facts['env']['HOME'] }}/.local/share/pnpm:{{ ansible_facts['env']['PATH'] }}"

- name: Generate app_icons.lua file from icon_map.lua in dist folder
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Check if icon_map.lua exists in dist
      ansible.builtin.stat:
        path: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font/dist/icon_map.lua"
      register: icon_map_stat

    - name: Ensure ~/.config/sketchybar/helpers directory exists
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.config/sketchybar/helpers"
        state: directory
        mode: "0755"

    - name: Copy icon_map.lua to app_icons.lua in helpers folder
      when: icon_map_stat.stat.exists
      ansible.builtin.copy:
        src: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font/dist/icon_map.lua"
        dest: "{{ ansible_facts['env']['HOME'] }}/.config/sketchybar/helpers/app_icons.lua"
        mode: "0644"

    - name: Ensure user Fonts directory exists
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/Library/Fonts"
        state: directory
        mode: "0755"

    - name: Install sketchybar-app-font TTF
      when: icon_map_stat.stat.exists
      ansible.builtin.copy:
        src: "{{ ansible_facts['env']['HOME'] }}/packages/sketchybar-app-font/dist/sketchybar-app-font.ttf"
        dest: "{{ ansible_facts['env']['HOME'] }}/Library/Fonts/sketchybar-app-font.ttf"
        mode: "0644"

    - name: Restart SketchyBar to apply new icon configurations
      ansible.builtin.shell: "brew services restart sketchybar"

- name: Brew Install (Languages)
  hosts: localhost
  become: false
  gather_facts: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  tasks:
    - name: Check Install - Lua
      community.general.homebrew:
        name: lua
        state: present

    - name: Check Install - C
      community.general.homebrew:
        name: c
        state: present

    - name: Check Install - Go
      community.general.homebrew:
        name: go
        state: present

- name: Brew Install (Fonts)
  hosts: localhost
  become: false
  gather_facts: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  tasks:
    - name: Check Install - Cascadia Code Font
      community.general.homebrew_cask:
        name: font-cascadia-code
        state: present

    - name: Check Install - Hack Nerd Font (SketchyBar)
      community.general.homebrew_cask:
        name: font-hack-nerd-font
        state: present

    - name: Check Install - JetBrains Mono Nerd Font (SketchyBar)
      community.general.homebrew_cask:
        name: font-jetbrains-mono-nerd-font
        state: present

- name: Install and Start Aerospace (last - so borders config loads properly)
  hosts: localhost
  become: false
  gather_facts: false
  environment:
    HOMEBREW_NO_ANALYTICS: "1"
  tasks:
    - name: Check Install - Aerospace
      community.general.homebrew_cask:
        name:
          - nikitabobko/tap/aerospace
        state: latest
      ignore_errors: true

    - name: Check if Aerospace is running
      shell: "pgrep -f 'Aerospace'"
      register: aerospace_status
      failed_when: false
      changed_when: false

    - name: Start Aerospace if not running
      shell: "open -a Aerospace"
      when: aerospace_status.rc != 0

