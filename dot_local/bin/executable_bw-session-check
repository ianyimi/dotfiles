#!/bin/bash
# Check and refresh Bitwarden session
# Handles all states: valid session, expired session, locked vault, and unauthenticated

# Suppress Node.js punycode deprecation warning from bw CLI
export NODE_OPTIONS="--no-deprecation"

# Source existing session if available
if [ -f ~/.bw-session ]; then
    source ~/.bw-session
fi

# Check if session is valid
if [ -n "$BW_SESSION" ] && bw unlock --check --session "$BW_SESSION" &>/dev/null; then
    echo "✓ Bitwarden session is valid"
    exit 0
fi

# Session invalid or missing
echo "⚠️  Bitwarden session expired or missing"

# Check if logged in, and login if not
if ! bw login --check &>/dev/null; then
    echo "Not logged in to Bitwarden. Logging in..."

    # Get email from chezmoi config if available
    BW_EMAIL=""
    if command -v chezmoi &>/dev/null; then
        BW_EMAIL=$(chezmoi data --format json 2>/dev/null | grep -o '"bwEmail":"[^"]*"' | cut -d'"' -f4)
    fi

    if [ -n "$BW_EMAIL" ]; then
        echo "Using email: $BW_EMAIL"
        BW_SESSION=$(bw login "$BW_EMAIL" --raw </dev/tty)
    else
        BW_SESSION=$(bw login --raw </dev/tty)
    fi

    if [ $? -ne 0 ] || [ -z "$BW_SESSION" ]; then
        echo "✗ Failed to log in"
        exit 1
    fi

    echo "export BW_SESSION=\"$BW_SESSION\"" > ~/.bw-session
    chmod 600 ~/.bw-session
    export BW_SESSION
    echo "✓ Logged in and session saved"
    exit 0
fi

# Logged in but vault is locked — unlock and refresh session
echo "Unlocking vault..."
BW_SESSION=$(bw unlock --raw </dev/tty)
if [ $? -eq 0 ] && [ -n "$BW_SESSION" ]; then
    echo "export BW_SESSION=\"$BW_SESSION\"" > ~/.bw-session
    chmod 600 ~/.bw-session
    export BW_SESSION
    echo "✓ Session refreshed"
else
    echo "✗ Failed to unlock"
    exit 1
fi
