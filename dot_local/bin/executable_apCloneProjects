#!/bin/bash

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}═══════════════════════════════════════${NC}"
echo -e "${CYAN}     GitHub Project Cloner${NC}"
echo -e "${CYAN}═══════════════════════════════════════${NC}"
echo ""

# Suppress Node.js deprecation warnings
export NODE_OPTIONS="--no-deprecation"

# Check if BW_SESSION is set
if [ -z "$BW_SESSION" ]; then
    if [ -f ~/.bw-session ]; then
        source ~/.bw-session
    else
        echo -e "${YELLOW}⚠${NC}  Bitwarden session not found. Unlocking..."
        export BW_SESSION=$(bw unlock --raw)
    fi
fi

# Sync Bitwarden vault to get latest items
echo "Syncing Bitwarden vault..."
bw sync --session "$BW_SESSION" &>/dev/null || true

# Check if gh CLI is installed and authenticated
if ! command -v gh &>/dev/null; then
    echo -e "${RED}✗${NC} GitHub CLI (gh) is not installed."
    echo "Installing gh..."
    brew install gh
fi

# Authenticate gh CLI using token from Bitwarden
if ! gh auth status &>/dev/null; then
    echo "Authenticating GitHub CLI with token from Bitwarden..."
    GITHUB_TOKEN=$(bw get password "GitHub Personal Access Token" 2>/dev/null || bw get password "GitHub API Token" 2>/dev/null)

    if [ -z "$GITHUB_TOKEN" ]; then
        echo -e "${RED}✗${NC} Could not find GitHub token in Bitwarden."
        echo "Please create a Bitwarden item named 'GitHub Personal Access Token' with your token as the password."
        exit 1
    fi

    echo "$GITHUB_TOKEN" | gh auth login --with-token
    echo -e "${GREEN}✓${NC} GitHub CLI authenticated"
fi

# Get list of user's repositories
echo "Fetching your GitHub repositories..."
REPOS=$(gh repo list --limit 100 --json name,description,url | jq -r '.[] | "\(.name)|\(.description)|\(.url)"')

if [ -z "$REPOS" ]; then
    echo -e "${RED}✗${NC} No repositories found or failed to fetch."
    exit 1
fi

# Display repositories with numbers
echo ""
echo -e "${BLUE}Your GitHub Repositories:${NC}"
echo ""

IFS=$'\n'
REPO_ARRAY=()
INDEX=1
for REPO in $REPOS; do
    NAME=$(echo "$REPO" | cut -d'|' -f1)
    DESC=$(echo "$REPO" | cut -d'|' -f2)
    REPO_ARRAY+=("$REPO")

    if [ -z "$DESC" ] || [ "$DESC" = "null" ]; then
        echo -e "${CYAN}[$INDEX]${NC} $NAME"
    else
        echo -e "${CYAN}[$INDEX]${NC} $NAME ${YELLOW}- $DESC${NC}"
    fi
    ((INDEX++))
done

echo ""
echo -e "${BLUE}Clone Options:${NC}"
echo "  - Enter numbers separated by spaces (e.g., '1 3 5')"
echo "  - Enter 'all' to clone all repositories"
echo "  - Enter 'q' to quit"
echo ""
read -p "Select repositories to clone: " SELECTION

if [ "$SELECTION" = "q" ]; then
    echo "Cancelled."
    exit 0
fi

# Parse selection
INDICES=()
if [ "$SELECTION" = "all" ]; then
    for i in $(seq 1 ${#REPO_ARRAY[@]}); do
        INDICES+=($i)
    done
else
    IFS=' ' read -ra INDICES <<< "$SELECTION"
fi

# Set clone directory
DEFAULT_CLONE_DIR="$HOME/Desktop/Projects"
echo ""
read -p "Clone directory [$DEFAULT_CLONE_DIR]: " CLONE_DIR
CLONE_DIR=${CLONE_DIR:-$DEFAULT_CLONE_DIR}

mkdir -p "$CLONE_DIR"

echo ""
echo -e "${BLUE}Cloning selected repositories...${NC}"
echo ""

# Clone each selected repository
for INDEX in "${INDICES[@]}"; do
    if [ "$INDEX" -ge 1 ] && [ "$INDEX" -le "${#REPO_ARRAY[@]}" ]; then
        REPO_INFO="${REPO_ARRAY[$((INDEX-1))]}"
        NAME=$(echo "$REPO_INFO" | cut -d'|' -f1)
        URL=$(echo "$REPO_INFO" | cut -d'|' -f3)

        echo -e "${CYAN}[${INDEX}/${#INDICES[@]}]${NC} Cloning $NAME as bare repository..."

        BARE_REPO_DIR="$CLONE_DIR/$NAME.git"
        WORKTREE_DIR="$CLONE_DIR/$NAME"

        # Clone as bare repository
        if git clone --bare "$URL" "$BARE_REPO_DIR"; then
            echo -e "${GREEN}✓${NC} Bare repository cloned: $NAME.git"

            # Determine which branch to use for worktree
            cd "$BARE_REPO_DIR"

            # Check if 'dev' branch exists
            if git show-ref --verify --quiet refs/heads/dev; then
                BRANCH="dev"
                echo -e "${BLUE}→${NC} Found 'dev' branch, creating worktree on dev"
            elif git show-ref --verify --quiet refs/heads/main; then
                BRANCH="main"
                echo -e "${BLUE}→${NC} Using 'main' branch for worktree"
            elif git show-ref --verify --quiet refs/heads/master; then
                BRANCH="master"
                echo -e "${BLUE}→${NC} Using 'master' branch for worktree"
            else
                # Fallback to default branch
                BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
                echo -e "${BLUE}→${NC} Using default branch: $BRANCH"
            fi

            # Create worktree
            if git worktree add "$WORKTREE_DIR" "$BRANCH" 2>/dev/null; then
                echo -e "${GREEN}✓${NC} Worktree created at: $WORKTREE_DIR (branch: $BRANCH)"
            else
                echo -e "${YELLOW}⚠${NC}  Worktree already exists or failed to create"
            fi

            cd - > /dev/null
        else
            echo -e "${RED}✗${NC} Failed to clone $NAME"
        fi

        echo ""
    fi
done

echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo -e "${GREEN}   ✓ Cloning Complete!${NC}"
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo ""
echo "Repositories cloned to: $CLONE_DIR"
echo ""
echo -e "${BLUE}Next step:${NC}"
echo "Run 'chezmoi apply' to restore any tracked .env files with Bitwarden secrets"
echo ""
echo -e "${BLUE}Managing project .env files:${NC}"
echo "  1. Create .env in project: $CLONE_DIR/<project>/.env"
echo "  2. Add to chezmoi: chezmoi add $CLONE_DIR/<project>/.env"
echo "  3. Edit template: chezmoi edit $CLONE_DIR/<project>/.env"
echo "  4. Replace secrets with: {{ (bitwarden \"item\" \"name\").login.password }}"
echo "  5. Commit to dotfiles repo"
echo "  6. On new machines, chezmoi will auto-restore to correct paths!"
echo ""
