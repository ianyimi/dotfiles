#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}═══════════════════════════════════════${NC}"
echo -e "${BLUE}    System Configuration Bootstrap     ${NC}"
echo -e "${BLUE}═══════════════════════════════════════${NC}"
echo ""

# Check if we should skip project cloning
SKIP_PROJECTS=false
if [[ "$1" == "--skip-projects" ]] || [[ "$1" == "-s" ]]; then
    SKIP_PROJECTS=true
    echo -e "${YELLOW}⏭  Skipping project cloning${NC}"
fi

# Step 1: Get sudo password early
echo -e "${BLUE}[1/6]${NC} Checking sudo access..."
sudo -v
# Keep sudo alive in background
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
echo -e "${GREEN}✓${NC} Sudo access confirmed"
echo ""

# Step 2: Install prerequisites (git, brew)
echo -e "${BLUE}[2/6]${NC} Installing prerequisites (git, brew)..."
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" </dev/tty
    if [[ $(uname -m) == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi
if ! command -v git &>/dev/null; then
    brew install git
fi
echo -e "${GREEN}✓${NC} Prerequisites installed"
echo ""

# Step 3: Install and configure Bitwarden CLI
echo -e "${BLUE}[3/6]${NC} Setting up Bitwarden CLI..."
if ! command -v bw &>/dev/null; then
    brew install bitwarden-cli
fi

# Configure server if needed (you'll be prompted during chezmoi init)
# This will be set in .chezmoi.toml.tmpl

# Step 4: Authenticate with Bitwarden
echo -e "${BLUE}[4/6]${NC} Authenticating with Bitwarden..."
if ! bw login --check &>/dev/null; then
    echo "Please login to Bitwarden:"
    bw login </dev/tty
fi

echo "Unlocking Bitwarden vault..."
export BW_SESSION=$(bw unlock --raw </dev/tty)
echo "export BW_SESSION=\"$BW_SESSION\"" > ~/.bw-session
chmod 600 ~/.bw-session
echo -e "${GREEN}✓${NC} Bitwarden authenticated and unlocked"
echo ""

# Step 5: Project cloning (unless skipped)
if [ "$SKIP_PROJECTS" = false ]; then
    echo -e "${BLUE}[5/6]${NC} Project Setup"
    echo ""

    if command -v apCloneProjects &>/dev/null; then
        apCloneProjects
    else
        echo -e "${YELLOW}⚠${NC}  apCloneProjects command not found yet. It will be available after chezmoi apply."
        echo "You can run it manually later with: apCloneProjects"
    fi
    echo ""
else
    echo -e "${BLUE}[5/6]${NC} Skipping project setup"
    echo ""
fi

# Step 6: Run Ansible playbook
echo -e "${BLUE}[6/6]${NC} Running system configuration (ansible)..."
echo "This will install all applications and CLI tools..."
echo ""

if [ ! -f ~/.bootstrap/macos.yml ]; then
    echo -e "${YELLOW}⚠${NC}  Applying chezmoi first to get bootstrap files..."
    chezmoi apply
fi

# Source Bitwarden session for ansible tasks that need it
if [ -f ~/.bw-session ]; then
    source ~/.bw-session
fi

ansible-playbook ~/.bootstrap/macos.yml --ask-become-pass </dev/tty

echo ""
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo -e "${GREEN}   ✓ Configuration Complete!${NC}"
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. Your secrets are available in: ~/.config/secrets.env"
echo "  3. Run 'apCloneProjects' anytime to clone more repos"
echo ""
