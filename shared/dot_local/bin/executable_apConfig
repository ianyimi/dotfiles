#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect OS
OS="$(uname -s)"

# Suppress Node.js deprecation warnings from bw CLI
export NODE_OPTIONS="--no-deprecation"

echo -e "${BLUE}═══════════════════════════════════════${NC}"
echo -e "${BLUE}    System Configuration Bootstrap     ${NC}"
echo -e "${BLUE}═══════════════════════════════════════${NC}"
echo ""

# Step 1: Verify Bitwarden session (should already be set by bootstrap.sh)
echo -e "${BLUE}[1/2]${NC} Checking Bitwarden session..."
if [ -f ~/.bw-session ]; then
    source ~/.bw-session
fi

if [ -n "$BW_SESSION" ] && bw unlock --check --session "$BW_SESSION" &>/dev/null; then
    echo -e "${GREEN}✓${NC} Bitwarden session valid"
else
    echo -e "${YELLOW}⚠${NC}  Bitwarden session expired, refreshing..."
    if command -v bw-session-check &>/dev/null; then
        bw-session-check
        source ~/.bw-session
    else
        # Fallback if helper script not available
        if ! bw login --check &>/dev/null; then
            echo "Please login to Bitwarden:"
            BW_SESSION=$(bw login --raw)
        else
            echo "Unlocking Bitwarden vault..."
            BW_SESSION=$(bw unlock --raw)
        fi
        echo "export BW_SESSION=\"$BW_SESSION\"" > ~/.bw-session
        chmod 600 ~/.bw-session
        export BW_SESSION
    fi
    echo -e "${GREEN}✓${NC} Bitwarden session refreshed"
fi
echo ""

# Step 2: Run Ansible playbook (OS-specific)
echo -e "${BLUE}[2/2]${NC} Running system configuration (ansible)..."
echo "This will install all applications and CLI tools..."
echo ""

case "$OS" in
    Darwin*)
        PLAYBOOK="$HOME/.bootstrap/macos.yml"
        ;;
    Linux*)
        PLAYBOOK="$HOME/.bootstrap/linux.yml"
        ;;
    *)
        echo -e "${RED}✗${NC} Unsupported operating system: $OS"
        exit 1
        ;;
esac

if [ ! -f "$PLAYBOOK" ]; then
    echo -e "${YELLOW}⚠${NC}  Applying chezmoi first to get bootstrap files..."
    chezmoi apply
fi

# Ensure BW_SESSION is exported for ansible tasks
if [ -f ~/.bw-session ]; then
    source ~/.bw-session
    export BW_SESSION
fi

if [ -z "$BW_SESSION" ]; then
    echo -e "${YELLOW}⚠${NC}  BW_SESSION not set. gh auth will be skipped."
    echo "  Run 'bw-session-check && source ~/.bw-session' to fix."
fi

# Run ansible with --ask-become-pass for plays that need sudo
ansible-playbook "$PLAYBOOK" --ask-become-pass

echo ""
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo -e "${GREEN}   ✓ Configuration Complete!${NC}"
echo -e "${GREEN}═══════════════════════════════════════${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. Your secrets are available in: ~/.config/secrets.env"
echo ""
