{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -e

echo "=== Installing Tailscale ==="

# Install Tailscale CLI (formula, not cask)
if ! command -v tailscale &>/dev/null; then
    echo "Installing Tailscale..."
    brew install tailscale
    echo "✓ Tailscale installed"
else
    echo "✓ Tailscale already installed"
fi

# Start the Tailscale daemon service
if ! brew services list | grep -q "tailscale.*started"; then
    echo "Starting Tailscale service..."
    sudo brew services start tailscale
    sleep 2
fi

# Check if already connected
if tailscale status &>/dev/null; then
    echo "✓ Tailscale already connected"
    echo "=== Tailscale setup complete ==="
    exit 0
fi

# Authenticate with Tailscale
echo ""
echo "=== Tailscale Authentication Required ==="
echo "Opening browser for authentication..."
echo "Please approve the device in your browser."
echo ""

# tailscale up opens browser and waits until auth completes
sudo tailscale up --accept-routes

echo ""
echo "✓ Tailscale connected"
echo "=== Tailscale setup complete ==="
{{ end -}}
