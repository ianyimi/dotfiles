{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -e

echo "=== Installing Tailscale ==="

# Install Tailscale if not present
if [ ! -d "/Applications/Tailscale.app" ]; then
    echo "Installing Tailscale..."
    brew install --cask tailscale
    echo "✓ Tailscale installed"
else
    echo "✓ Tailscale already installed"
fi

# Check if already connected
if /Applications/Tailscale.app/Contents/MacOS/Tailscale status &>/dev/null; then
    echo "✓ Tailscale already connected"
    echo "=== Tailscale setup complete ==="
    exit 0
fi

# Start Tailscale app and wait for connection
echo ""
echo "=== Tailscale Authentication Required ==="
echo "Opening Tailscale app - please:"
echo "  1. Click 'Connect' in the Tailscale app"
echo "  2. Authenticate in your browser"
echo "  3. Approve the device"
echo ""

open /Applications/Tailscale.app
sleep 2

echo "Waiting for Tailscale to connect..."
while ! /Applications/Tailscale.app/Contents/MacOS/Tailscale status &>/dev/null; do
    sleep 3
done

echo "✓ Tailscale connected"
echo "=== Tailscale setup complete ==="
{{ end -}}
