{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -e

echo "=== Installing Tailscale ==="

# Install Tailscale if not present
if ! brew list --cask tailscale &>/dev/null; then
    echo "Installing Tailscale..."
    brew install --cask tailscale
    echo "✓ Tailscale installed"
else
    echo "✓ Tailscale already installed"
fi

# Define the Tailscale CLI path
TAILSCALE="/Applications/Tailscale.app/Contents/MacOS/Tailscale"

# Check if already connected
if "$TAILSCALE" status &>/dev/null; then
    echo "✓ Tailscale already connected"
    echo "=== Tailscale setup complete ==="
    exit 0
fi

# Start Tailscale app first (needed to start the daemon on macOS)
echo ""
echo "=== Tailscale Authentication Required ==="
echo "Starting Tailscale and opening browser for authentication..."
echo "Please approve the device in your browser."
echo ""

# Open the app to start the system extension/daemon
open /Applications/Tailscale.app
sleep 3

# Use tailscale up which will open browser and wait for auth
# The --accept-routes flag accepts subnet routes from your tailnet
"$TAILSCALE" up --accept-routes

echo ""
echo "✓ Tailscale connected"
echo "=== Tailscale setup complete ==="
{{ end -}}
